<!doctype html>
<html lang="en">
<head>
  <!-- Material Components for Web CSS -->
  <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>

<div id="statusOverlay" style="display:none;"><span id="statusMessage"></span><i class="material-icons close-overlay" title="Close">close</i></div>

<style>
#statusOverlay{
  display:none;
  position: fixed;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.85);
  color: #fff;
  padding: 10px 20px;
  border-radius: 4px;
  font-weight: 500;
  z-index: 1050;
  display:flex;
  align-items:center;
  gap:12px;
  cursor:pointer; /* allow click anywhere to dismiss */
  transition: opacity .35s ease;
}

#statusOverlay .close-overlay{
  font-size:20px;
  opacity:0.9;
}
</style>

<style>
.section-title{margin:25px 0 15px;font-weight:600;}

.rooms-grid{display:flex;flex-wrap:wrap;margin:-8px;}
.room-col{padding:8px;width:100%;}
@media(min-width:768px){.room-col{width:50%;}}
@media(min-width:992px){.room-col{width:33.333%;}}
@media(min-width:992px){.room-col{width:50%;}}

.room-card{border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1);overflow:hidden;}
.room-card .panel-heading{background:#ffffff;border:none;}
.room-card .panel-body{background:#f9f9f9;}

.playlist-card{border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1);}
.playlist-card .panel-heading{background:#ffffff;border:none;padding:10px 15px;}
</style>

<style>
/* Warm color palette overrides */
body{background:#fff8f2;}

/* Card headings and bodies */
.panel-heading{background:#ffe8d9 !important;}
.panel-body{background:#fff5ed !important;}

/* Buttons */
.btn-primary{background-color:#ff7b54;border-color:#ff7b54;}
.btn-primary:hover{background-color:#ff693a;border-color:#ff693a;}

.btn-info{background-color:#ffb26b;border-color:#ffb26b;color:#fff;}
.btn-info:hover{background-color:#ffa34f;border-color:#ffa34f;}

.btn-success{background-color:#ff9b6a;border-color:#ff9b6a;}
.btn-success:hover{background-color:#ff8650;border-color:#ff8650;}

.btn-warning{background-color:#ffad60;border-color:#ffad60;}
.btn-warning:hover{background-color:#ff9b42;border-color:#ff9b42;}

/* Panel border */
.panel-default{border-color:#ffd8bf;}

.section-title{color:#d45d00;}

#statusOverlay{background:rgba(255,135,90,.95);} 
</style>

<!-- Mobile button sizing -->
<style>
@media (max-width: 768px){
    /* Global touch-friendly button sizing */
    .btn-xs{
        padding: 14px 22px;
        font-size: 18px;
        line-height: 1.5;
        border-radius: 8px;
    }

    /* Circular icon buttons */
    .playlist-play-btn.btn-xs,
    .playlist-toggle.btn-xs{
        width:56px;
        height:56px;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:24px;
        padding:0;
        border-radius:50%;
    }
}
</style>

{% with messages = get_flashed_messages(with_categories=true) %}
  <!-- Categories: success (green), info (blue), warning (yellow), danger (red) -->
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible" role="alert">
      <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <!-- <strong>Title</strong> --> {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}


<div class="container">

  <h3 class="section-title">Rooms</h3>
  <ul class="mdc-list rooms-list" id="roomsList">
    {% for zone in zones %}
      <li class="mdc-list-item room-item" data-room="{{ zone.player_name }}">
        <span class="mdc-list-item__ripple"></span>
        <button type="button" class="mdc-button mdc-button--unelevated room-link" data-room="{{ zone.player_name }}">
          <span class="mdc-button__label">{{ zone.player_name }}</span>
        </button>
        <div class="room-details" style="display:none;">
          <div class="room-stack">
              <img src="" alt="art" class="album-art" data-room="{{ zone.player_name }}" />

              <!-- Scrubber -->
              <div class="progress track-progress" data-room="{{ zone.player_name }}" style="height:6px;margin:8px 0; cursor:pointer;">
                  <div class="progress-bar" role="progressbar" style="width:0%;" data-room="{{ zone.player_name }}"></div>
              </div>

              <!-- Time display -->
              <div class="time-display" style="font-size:12px;width:100%;">
                  <span class="time-current" data-room="{{ zone.player_name }}">0:00</span>
                  <span class="time-remaining" data-room="{{ zone.player_name }}">-0:00</span>
              </div>

              <!-- Song title -->
              <p class="track-info" data-room="{{ zone.player_name }}" style="margin:8px 0 4px; text-align:center;">Loading...</p>

              <!-- Volume controls -->
              <div class="room-controls volume-controls" style="justify-content:center; margin:6px 0;">
                 <button class="mdc-icon-button volume-btn" data-change="down" data-room="{{ zone.player_name }}">
                   <i class="material-icons mdc-icon-button__icon">remove</i>
                 </button>
                 <span class="room-volume circle-btn" data-room="{{ zone.player_name }}">--</span>
                 <button class="mdc-icon-button volume-btn" data-change="up" data-room="{{ zone.player_name }}">
                   <i class="material-icons mdc-icon-button__icon">add</i>
                 </button>
              </div>

              <!-- Playback controls -->
              <div class="room-controls playback-controls" style="justify-content:center; margin-top:6px;">
                 <button class="mdc-icon-button track-btn" data-dir="prev" data-room="{{ zone.player_name }}">
                   <i class="material-icons mdc-icon-button__icon">skip_previous</i>
                 </button>
                 <button class="mdc-icon-button room-action" data-action="play" data-room="{{ zone.player_name }}">
                   <i class="material-icons mdc-icon-button__icon">play_arrow</i>
                 </button>
                 <button class="mdc-icon-button track-btn" data-dir="next" data-room="{{ zone.player_name }}">
                   <i class="material-icons mdc-icon-button__icon">skip_next</i>
                 </button>
              </div>
          </div>
        </div>
      </li>
    {% endfor %}
  </ul>

  <!-- Hide old grid layout -->
  <div class="rooms-grid" id="roomsAccordion" style="display:none;"></div>

<br />

<h3 class="section-title">Play Lists</h3>
  <div class="playlist-grid">
  {% for pl in playlists %}
   <div class="playlist-col">
    <div class="mdc-card playlist-card" style="margin-bottom:10px;">
      <div class="mdc-card__content playlist-heading">
          <strong>{{ pl }}</strong>
          <div class="playlist-btn-group">
            <button type="button" class="mdc-icon-button playlist-play-btn" data-playlist="{{ pl }}">
              <i class="material-icons mdc-icon-button__icon">play_arrow</i>
            </button>
            <button type="button" class="mdc-icon-button playlist-toggle" data-target="#toggleDemo_{{ loop.index }}" data-playlist="{{ pl }}">
              <i class="material-icons mdc-icon-button__icon">list</i>
            </button>
          </div>
      </div>
      <div class="mdc-card__content" style="padding:8px 15px;">
          <div class="playlist-collapse" id="toggleDemo_{{ loop.index }}" style="margin-top:8px; display:none;">
               <!-- Track list will be populated here -->
          </div>
      </div>
    </div>
   </div>
  {% endfor %}
  </div> <!-- playlist-grid -->

<!-- Custom overrides for better app-like styling -->
<style>
/* Smaller square padding removal for room buttons */
.room-card .mdc-card__media--square {
    padding-top: 0; /* remove enforced 1:1 ratio */
    height: auto;
}

/* Room link button sizing */
.room-link {
    width: 100%;
    padding: 8px 12px;
    font-size: 16px;
    line-height: 1.2;
    --mdc-theme-primary: #1976d2; /* use primary color */
}

/* Close button top-left positioning */
.mdc-dialog__header {
    display: flex;
    align-items: center;
}
.mdc-dialog__header .mdc-dialog__close {
    order: -1; /* appear before title */
    margin-right: 12px;
}

/* Playlist room-choice buttons */
.room-choice.mdc-button {
    width: 100%;
    margin: 6px 0;
    justify-content: flex-start;
}
</style>

<!-- Room detail dialog -->
<div class="mdc-dialog" id="roomDetailModal">
  <div class="mdc-dialog__container">
    <div class="mdc-dialog__surface" role="alertdialog" aria-modal="true">
      <div class="mdc-dialog__header">
        <button class="mdc-icon-button mdc-dialog__close" data-mdc-dialog-action="close">
          <i class="material-icons">close</i>
        </button>
        <h2 class="mdc-dialog__title" id="roomModalTitle">Room</h2>
      </div>
      <div class="mdc-dialog__content" id="roomModalBody">
        <!-- dynamic room controls will be placed here -->
      </div>
    </div>
  </div>
  <div class="mdc-dialog__scrim"></div>
</div>

<!-- Room select dialog -->
<div class="mdc-dialog" id="roomSelectModal">
  <div class="mdc-dialog__container">
    <div class="mdc-dialog__surface" role="alertdialog" aria-modal="true">
      <div class="mdc-dialog__header">
        <button class="mdc-icon-button mdc-dialog__close" data-mdc-dialog-action="close">
          <i class="material-icons">close</i>
        </button>
        <h2 class="mdc-dialog__title">Select Room</h2>
      </div>
      <div class="mdc-dialog__content">
        <div id="roomList" class="mdc-list">
          {% for zone in zones %}
             <button class="mdc-button mdc-button--raised room-choice" data-room="{{ zone.player_name }}">
               <span class="mdc-button__label">{{ zone.player_name }}</span>
             </button>
          {% endfor %}
        </div>
      </div>
      <div class="mdc-dialog__actions">
        <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="close">
          <span class="mdc-button__label">Cancel</span>
        </button>
      </div>
    </div>
  </div>
  <div class="mdc-dialog__scrim"></div>
</div>

</div>

<!-- Material Components for Web JS -->
<script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>

<script>
// Initialize MDC components
let roomDetailDialog, roomSelectDialog;

document.addEventListener('DOMContentLoaded', () => {
    // Initialize dialogs
    roomDetailDialog = new mdc.dialog.MDCDialog(document.getElementById('roomDetailModal'));
    roomSelectDialog = new mdc.dialog.MDCDialog(document.getElementById('roomSelectModal'));
    
    // Attach ripple effect to all MDC buttons for better UX
    document.querySelectorAll('.mdc-button').forEach(el => {
        mdc.ripple.MDCRipple.attachTo(el);
    });
    
    // Playlist toggle handler
    document.addEventListener('click', (e) => {
        const btn = e.target.closest('.playlist-toggle');
        if (!btn) return;
        
        const target = btn.dataset.target;
        const targetDiv = document.querySelector(target);
        const isLoaded = targetDiv.dataset.loaded;
        
        if (!isLoaded) {
            const plName = btn.dataset.playlist;
            fetch(`/playlist_tracks?play_list=${encodeURIComponent(plName)}&secret_key={{ secret_key }}`)
                .then(r => r.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        const ol = document.createElement('ol');
                        data.forEach(track => {
                            const li = document.createElement('li');
                            li.textContent = `${track.title} - ${track.creator} - ${track.album}`;
                            ol.appendChild(li);
                        });
                        targetDiv.appendChild(ol);
                        targetDiv.dataset.loaded = 'true';
                    } else if (data.error) {
                        const p = document.createElement('p');
                        p.className = 'mdc-theme--error';
                        p.textContent = data.error;
                        targetDiv.appendChild(p);
                    }
                });
        }
        
        // Toggle visibility
        targetDiv.style.display = targetDiv.style.display === 'none' ? 'block' : 'none';
    });
});
</script>

<script>
function showStatus(msg,duration=4000){
  const ov = document.getElementById('statusOverlay');
  const msgSpan = document.getElementById('statusMessage');
  if(msgSpan){
      msgSpan.textContent = msg;
  }else{
      ov.textContent = msg; // fallback
  }

  // Reset any existing timers
  clearTimeout(ov._fadeTimer);
  clearTimeout(ov._hideTimer);

  ov.style.display = 'flex';
  requestAnimationFrame(()=>{
      ov.style.opacity = '1';
  });

  ov._fadeTimer = setTimeout(()=>{
      ov.style.opacity = '0';
  }, duration);

  ov._hideTimer = setTimeout(()=>{
      ov.style.display = 'none';
  }, duration + 400); // wait for fade transition
}

// Allow user to dismiss manually by clicking anywhere or the close icon
document.addEventListener('DOMContentLoaded', ()=>{
  const ov = document.getElementById('statusOverlay');
  ov.addEventListener('click', ()=>{
      ov.style.opacity = '0';
      setTimeout(()=>{ ov.style.display='none'; }, 350);
  });
});

document.addEventListener('DOMContentLoaded', () => {
  const secretKey = '{{ secret_key }}';

  // --- ROOM MODAL BEHAVIOUR ---
  let roomModalPollId = null;
  document.addEventListener('click', (e) => {
      const roomBtn = e.target.closest('.room-link');
      if (!roomBtn) return;
      e.preventDefault();
      const room = roomBtn.dataset.room;

      const panel = roomBtn.closest('.room-item');
      const bodyHtml = panel.querySelector('.room-details').innerHTML;
      document.getElementById('roomModalTitle').textContent = room;
      document.getElementById('roomModalBody').innerHTML = bodyHtml;

      roomDetailDialog.open();

      const updateRoomModal = function(){
          fetch(`/room_status?room=${encodeURIComponent(room)}&secret_key=${secretKey}&ajax=1`)
              .then(r => r.json())
              .then(res => {
              if(res.status === 'ok'){
                  // Update progress bar
                  updateProgressBar(room, res.duration_sec, res.position_sec);

                  document.querySelectorAll(`[data-room="${room}"].track-info`).forEach(el => el.textContent = res.track);
                  document.querySelectorAll(`[data-room="${room}"].room-volume`).forEach(el => el.textContent = `Vol ${res.volume}`);

                  const imgs = document.querySelectorAll(`[data-room="${room}"].album-art`);
                  imgs.forEach(img => {
                      if(img.dataset.current !== res.title){
                          img.dataset.loaded = 'false';
                          img.dataset.current = res.title;
                      }
                  });
                  if(imgs.length) {
                      fetchAlbumArt(room, res.title, res.artist);
                  }

                  const btns = document.querySelectorAll(`[data-room="${room}"].room-action`);
                  btns.forEach(btn => {
                      const action = res.is_playing ? 'pause' : 'play';
                      btn.dataset.action = action;
                      const icon = btn.querySelector('i');
                      if(action === 'pause'){
                          icon.textContent = 'pause';
                      }else{
                          icon.textContent = 'play_arrow';
                      }
                  });
              }
          });
      };

      updateRoomModal();
      if(roomModalPollId){ clearInterval(roomModalPollId); }
      roomModalPollId = setInterval(updateRoomModal, 5000);
  });

  roomDetailDialog.listen('MDCDialog:closed', () => {
      if(roomModalPollId){
          clearInterval(roomModalPollId);
          roomModalPollId = null;
      }
  });

  document.addEventListener('click', (e) => {
      const btn = e.target.closest('.room-action');
      if (!btn) return;
      e.preventDefault();
      const room = btn.dataset.room;
      const action = btn.dataset.action;
      const endpoint = action === 'pause' ? '/wake' : '/play';
      fetch(`${endpoint}?room=${encodeURIComponent(room)}&secret_key=${secretKey}&ajax=1`)
          .then(r => r.json())
          .then(res => {
              if(res.status === 'ok'){
                  let msg;
                  const icon = btn.querySelector('i');
                  if(res.is_playing){
                      btn.dataset.action = 'pause';
                      icon.textContent = 'pause';
                      msg = 'Playback Started';
                  }else{
                      btn.dataset.action = 'play';
                      icon.textContent = 'play_arrow';
                      msg = 'Playback Paused';
                  }
                  showStatus(msg);
              }
          });
  });

  document.addEventListener('click', (e) => {
      const btn = e.target.closest('.volume-btn');
      if (!btn) return;
      e.preventDefault();
      const room = btn.dataset.room;
      const change = btn.dataset.change;
      fetch(`/volume?room=${encodeURIComponent(room)}&change=${change}&secret_key=${secretKey}&ajax=1`)
          .then(r => r.json())
          .then(res => {
              if(res.status === 'ok'){
                  document.querySelectorAll(`[data-room="${room}"].room-volume`).forEach(el => el.textContent = `Vol ${res.volume}`);
                  showStatus(`Volume Updated to ${res.volume}`);
              }
          });
  });

  // Note: Room cards no longer use accordion collapse - they open in modal instead

  let selectedPlaylist = null;
  document.addEventListener('click', (e) => {
      const btn = e.target.closest('.playlist-play-btn');
      if (!btn) return;
      selectedPlaylist = btn.dataset.playlist;
      if (roomSelectDialog) {
          roomSelectDialog.open();
      } else {
          // Fallback: reload page if dialog failed (rare)
          window.location.reload();
      }
  });

  document.addEventListener('click', (e) => {
      const choice = e.target.closest('.room-choice');
      if (!choice) return;
      e.preventDefault();
      const room = choice.dataset.room;
      if(!selectedPlaylist) return;
      window.location = `/sonos_playlist?play_list=${encodeURIComponent(selectedPlaylist)}&room=${encodeURIComponent(room)}&secret_key=${secretKey}`;
  });

  document.addEventListener('click', (e) => {
      const btn = e.target.closest('.track-btn');
      if (!btn) return;
      e.preventDefault();
      const room = btn.dataset.room;
      const dir = btn.dataset.dir;
      const endpoint = dir === 'next' ? '/next' : '/previous';
      fetch(`${endpoint}?room=${encodeURIComponent(room)}&secret_key=${secretKey}&ajax=1`)
          .then(r => r.json())
          .then(res => {
              if(res.status === 'ok'){
                  showStatus(dir === 'next' ? 'Skipped to Next' : 'Went to Previous');
                  document.querySelectorAll(`[data-room="${room}"].track-info`).forEach(el => el.textContent = 'Loading...');
                  setTimeout(() => {
                      const targetPanel = document.querySelector(`[data-room="${room}"].room-action`).closest('.room-details');
                      if(targetPanel){
                          targetPanel.dataset.loaded = 'false';
                          targetPanel.style.display = 'block';
                      }
                  }, 500);
              }
          });
  });

  // --- Drag seek logic ---
  window.dragState = null; // global state {room, duration, $container, posSec}

  function handleSeek(room,posSec,duration){
      fetch(`/seek?room=${encodeURIComponent(room)}&position_sec=${posSec}&secret_key=${secretKey}&ajax=1`)
          .then(r => r.json())
          .then(res => {
              if(res.status === 'ok'){
                  showStatus('Seeked to '+fmt(posSec));
              }
          });
  }

  document.addEventListener('mousedown', (e) => {
      const container = e.target.closest('.track-progress');
      if (!container) return;
      const room = container.dataset.room;
      const duration = container.dataset.duration;
      if(!duration) return;

      window.dragState = {room: room, duration: duration, container: container};
      container.classList.add('notrans');

      // Immediately update position at touch point
      updateDrag(e);
  });

  function updateDrag(evt){
      if(!window.dragState) return;
      const c = window.dragState.container;
      const rect = c.getBoundingClientRect();
      const offsetX = evt.pageX - rect.left;
      let pct = offsetX / rect.width;
      pct = Math.max(0, Math.min(pct,1));
      const posSec = Math.round(pct * window.dragState.duration);
      window.dragState.posSec = posSec;
      updateProgressBar(window.dragState.room, window.dragState.duration, posSec, false, true);
  }

  document.addEventListener('mousemove', (e) => {
      if(!window.dragState) return;
      const evt = e.type === 'touchmove' ? e.touches[0] : e;
      updateDrag(evt);
  });

  document.addEventListener('mouseup', (e) => {
      if(!window.dragState) return;
      handleSeek(window.dragState.room, window.dragState.posSec, window.dragState.duration);
      window.dragState.container.classList.remove('notrans');
      window.dragState = null;
  });
});

// album art
function fetchAlbumArt(room,title,artist){
    if(!title) return;
    const imgs = document.querySelectorAll(`[data-room="${room}"].album-art`);
    if(!imgs.length || imgs[0].dataset.loaded === 'true') return;

    const q = (title + ' ' + artist).trim();

    fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(q)}&entity=song&limit=1`)
        .then(r => r.json())
        .then(data => {
            if(data.results && data.results.length){
                const artUrl = data.results[0].artworkUrl100.replace(/100x100/, '250x250');
                imgs.forEach(img => {
                    img.src = artUrl;
                    img.dataset.loaded = 'true';
                });
            }
        });
}

// Function to format seconds as m:ss
function fmt(sec){
    if(sec < 0) sec = 0;
    var m = Math.floor(sec/60);
    var s = sec % 60;
    return m+":"+("0"+s).slice(-2);
}

function updateProgressBar(room,durationSec,posSec, skipInit, skipOverrideGuard){
    const containers = document.querySelectorAll(`[data-room="${room}"].track-progress`);
    if(!containers.length) return;

    containers.forEach(container => {
        if(!skipOverrideGuard && window.dragState && window.dragState.room === room) return;

        if(!durationSec || durationSec === 0){
            const bar = container.querySelector('.progress-bar');
            if(bar) bar.style.width = '0%';
            return;
        }

        const lastPos = parseFloat(container.dataset.lastPos) || 0;
        const isRewind = posSec < lastPos - 1;

        if(!skipInit && !container.dataset.initialized){
            container.classList.add('notrans');
            const bar = container.querySelector('.progress-bar');
            if(!bar) return;
            const pct = Math.min((posSec/durationSec)*100, 100);
            bar.style.width = pct + '%';
            requestAnimationFrame(() => {
                container.classList.remove('notrans');
            });
            container.dataset.initialized = 'true';
        }else{
            const pct = Math.min((posSec/durationSec)*100, 100);
            const bar = container.querySelector('.progress-bar');
            if(!bar) return;
            if(isRewind){
                container.classList.add('notrans');
            }
            bar.style.width = pct + '%';
            if(isRewind){
                requestAnimationFrame(() => {
                    container.classList.remove('notrans');
                });
            }
        }

        container.dataset.duration = durationSec;
        container.dataset.lastPos = posSec;
    });

    document.querySelectorAll(`[data-room="${room}"].time-current`).forEach(el => {
        el.textContent = fmt(posSec);
    });
}
</script>

</body>
</html>